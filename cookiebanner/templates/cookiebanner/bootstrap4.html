{% load i18n %}
<div id="cookiebanner" class="hidden text-white dark:text-red-100 bg-red-500 dark:bg-red-700" tabindex="-1" role="dialog" aria-labelledby="cookiebannerModalLabel" aria-hidden="true">
  <div class="mx-auto pt-3 px-4 pb-4 sm:pb-3 sm:px-6 max-w-7xl text-sm text-center">
    
    <h3 class="mb-3 sm:mb-2 text-lg font-semibold">{{cb_settings.title}}</h3> 
    
    {% if cb_settings.header_text %}
      <!-- TODO: the link to the Privacy and Cookie policy needs to be added in the url.py file! -->
      <p class="mb-3 sm:mb-2">{{ cb_settings.header_text|safe }}</p>
    {% endif %}
    
    <form id="cookiebanner-form">
      {% for cookiegroup in cb_settings.groups %}
      <div id="cookiegroup-{{ cookiegroup.id }}" class="mb-3 sm:mb-2">
        
        <div class="flex items-center justify-center gap-2">
          <label class="switch">
            <input type="checkbox" name="{{ cookiegroup.id }}" {% if not cookiegroup.optional %}checked disabled{% endif %}>
            <span class="slider"></span>
          </label>
          <h4 class="text-base font-semibold">{{ cookiegroup.name }}</h4>
        </div>
        
        <p class="">{{ cookiegroup.description }}</p>
        
        <!-- The following could be hidden using info buttons -->
        <!--<button class="button" type="button" data-toggle="collapse" data-target="#detailCollapse_{{ cookiegroup.id }}" aria-expanded="false" aria-controls="detailCollapse_{{ cookiegroup.id }}">{% trans 'Show cookie details' %}</button> 
          
        <div class="collapse" id="detailCollapse_{{ cookiegroup.id }}">
          <div class="card card-body">
            <table> 
              {% for cookie in cookiegroup.cookies %}
              <tr>
                <td>{{ cookie.pattern }}</td>       
                <td>{{ cookie.description }}</td>  
              </tr>
              {% endfor %}                
            </table>
          </div>
        </div>-->
        
      </div>
      {% endfor %}
    </form>
    
    {% if cb_settings.footer_text %}
    <p class="mb-3 sm:mb-2">{{ cb_settings.footer_text|safe }}</p>
    {% endif %}
    
    <div class="flex justify-center gap-2 mt-3 mb-1">
      <input type="submit" name="enable_all" class="btn py-1 px-2" value="{% trans 'Accept all' %}">
      <input type="submit" name="save" class="btn py-1 px-2" value="{% trans 'Save' %}">
    </div>

    <nav class="cookie-footer-links">
      {% for link in cb_settings.footer_links %}
      <span class="nav-item"><a class="nav-link" href="{{ link.href }}">{{ link.title }}</a></span>
      {% endfor %}
    </nav>
    
  </div>
</div>

<script>
  const cookiegroups = JSON.parse("{{ cookiegroups_json|escapejs }}");

  // Execute the following when the page has loaded
  document.addEventListener("DOMContentLoaded", function () {
    console.log(document.cookie.split(/;\s*/g));

    // check if cookiebanner cookie already exists
    if (getCookieData("cookiebanner"))
      return;
    
    // make cookie banner visible
    document.getElementById("cookiebanner").classList.remove("hidden");
    
    // add listeners for submit buttons
    document.getElementsByName("enable_all")[0].addEventListener("click", submitCookies);
    document.getElementsByName("save")[0].addEventListener("click", submitCookies);
  });

  function getCookieData(cname) {
    if (!document.cookie)
      return null;
    
    let cookies = document.cookie.split(/;\s*/g);
    let c = cookies.find((e) => e.match(`^${cname}=`));
    
    return c ? c.substr(cname.length + 1) : null;
  }


  function submitCookies() {
    let enabled_cookies;
    let buttonName = this.name;

    switch (buttonName) {
      case "enable_all":
        // get all cookie group ids
        enabled_cookies = cookiegroups.map((x) => x.id);
        break;

      case "save":
        // get input data for cookie banner
        const formData = new FormData(document.getElementById("cookiebanner-form"));

        // The following makes an assumption that the form only
        // contains checkboxes.
        // This also makes the assumption that 'essential'
        // does not show up because it is disabled.

        let checked_cookiegroups = [];
        for (let pair of formData.entries()) {
          if (pair[1] == "on")
            checked_cookiegroups.push(pair[0]);
        }
        
        enabled_cookies = cookiegroups.filter((x) => {
          if (checked_cookiegroups.includes(x.id))
            return x;
          else
            return !x.optional;
        }).map((x) => x.id);

        break;

      default:
        console.log("Error submitting cookies: Invalid button name " + buttonName)
        return null;
    }

    // set the cookiebanner cookie
    let max_age = (365 * 24 * 60 * 60);
    document.cookie = `cookiebanner=${encodeURIComponent(enabled_cookies)}; path=/; max-age=${max_age}; secure`;
    location.reload();
  }
</script>

<!--<style>
  
  .cookiebanner {
    display: none; /* display enabled via JS */
    background-color: #FFFF00;
    color: #FFFFFF;
  }
  
  .cookiebanner > div {
    padding: 1rem;
    text-align: center;
  }
  
  .cookiebanner *::selection {
    background: #FFF;
    color: #FF0000;
  }
  
  .cookiebanner a {
    color: #80FFFF;
;
  }
  
  .cookiebanner h3 {
    margin-top: 0;
  }
  
  .cookiebanner h4 {
    display: inline-block;
    margin: 0 0 0 .7rem;
  }

  .cookiebanner .cookiegroup {
    max-width: 800px;
    margin: auto;
    display: flex;
    align-items: center;
  }

  .cookiebanner .cookiegroup .slider-container {
    display: flex;
    align-items: center;
    margin: .5rem 1rem .5rem 0;
  }
  .cookiebanner .slider-container:after {
    content: "â€”";
    margin-left: 1rem;
  }

  @media (max-width: 800px) {
    .cookiebanner .cookiegroup {
      flex-direction: column;
    }

    .cookiebanner .cookiegroup .slider-container {
      margin: .5rem 0 0 0;
    }
    .cookiebanner .slider-container:after {
      content: "";
      margin: 0;
    }
  }

  .cookiebanner .description {
    flex-grow: 1;
  }

  /* The switch - the box around the slider */
  .cookiebanner .switch {
    position: relative;
    display: inline-block;
    width: 40px;
    height: 22px;
  }
  
  /* Hide default HTML checkbox */
  .cookiebanner .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  
  /* The slider */
  .cookiebanner .switch .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    -webkit-transition: .4s;
    transition: .4s;
  }
  
  .cookiebanner .switch .slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 2px;
    bottom: 2px;
    background-color: white;
    -webkit-transition: .4s;
    transition: .4s;
  }
  
  .cookiebanner .switch input:checked + .slider {
    background-color: rgba(34, 154, 255, 0.4);
  }
  .cookiebanner .switch input:checked:disabled + .slider {
    background-color: rgba(34, 154, 255, 0.4);
  }
  .cookiebanner .switch input:checked:disabled + .slider:hover {
    cursor: not-allowed;
  }
  .cookiebanner .switch input:focus + .slider {
    box-shadow: 0 0 1px #2196F3;
  }
  .cookiebanner .switch input:checked + .slider:before {
    -webkit-transform: translateX(18px);
    -ms-transform: translateX(18px);
    transform: translateX(18px);
  }
  
  /* Rounded sliders */
  .cookiebanner .switch .slider .round {
    border-radius: 34px;
  }
  .cookiebanner .switch .slider .round:before {
    border-radius: 50%;
  }
  
</style>-->